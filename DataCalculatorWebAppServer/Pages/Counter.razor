@* This is the Upload Data page -- still need to modify the UI*@
@page "/counter"
@using BlazorInputFile
@using Models
@using Data
@using Services
@using System.Diagnostics
@using Amazon
@using Amazon.S3.Model

@inject DataCalculatorDbContext _context 
@inject MetaDataDbContext _md_context
@inject IFileHandler _fileHandler

@* The form *@
<h3>Upload Data</h3>
<div class="sendFileForm">
      <EditForm Model=@data OnValidSubmit=@HandleValidSubmit>

        <div class="form-group">
            <label for="File">File</label>
            <BlazorInputFile.InputFile id="File" class="form-control" accept=".json" OnChange="@HandleFileUpload" multiple />
            <strong>
                file(s) selected: @fileName
            </strong>
        </div>
        <button class="btn btn-primary" type="submit">Send file</button>
    </EditForm>
    <p>@message</p>
    <p>@message2</p>
    <p>@message3</p>
    <p>@UploadTimeMessage</p>
</div>


@code {
    private List<FileSendData> data = new List<FileSendData>(); 

    private string message;

    private string message2;

    private string message3;

    private string fileName;

    private string UploadTimeMessage;

    private string timeToUpload;

    private async void HandleValidSubmit()
    {
        if (data.Count != 0)
        {
            bool etlCheck = false;
            Stopwatch stopwatch = new Stopwatch();

            message = "Uploading to Amazon S3";

            stopwatch.Start();
            foreach (FileSendData datum in data)
            {
                etlCheck = false;
                _md_context.UploadMetaData(datum);
                await _fileHandler.UploadFileAsync(datum, "seconddatacalc/read");
                etlCheck = await ifExists(datum.Year);
            }
            
            if (etlCheck)
            {
                stopwatch.Stop();
            }
            

            long seconds = stopwatch.ElapsedMilliseconds / 1000;
            message = "All files are now uploaded to S3";
            message2 = "All Metadata of the all files are now uploaded to S3";
            UploadTimeMessage = $"Time to upload is: {seconds} seconds";
            base.StateHasChanged();

        }

        else
        {
            message = "You did not upload anything. Please try again.";
        }


    }

    private void HandleFileUpload(IFileListEntry[] file)
    {
        Random rnd = new Random();
        List<string> fileYears = new List<string>();

        for (int i = 0; i < file.Length; i++)
        {
            data.Add(new FileSendData());

            if (file[i] != null)
            {
                data[i].File = file[i];
                data[i].Id = rnd.Next(201);
                fileName = data[i].File.Name;
                data[i].FileName = fileName;
                data[i].Type = data[i].File.Type;
                data[i].Size = data[i].File.Size;
                data[i].Date = data[i].File.LastModified;
                data[i].Year = data[i].GetYear();
                fileYears.Add(data[i].Year);
                data[i].Path = data[i].File.RelativePath;
            }
            else
            {
                message = "Error: A Null file exists";
            }
        }
    }

    private async Task<bool> ifExists(string fileYear)
    {
        List<string> fileNames = await getGlueResults();

        List<string> newlist = fileNames.Where(item => item.Contains(fileYear)).ToList();

        message = "Performing ETL in AWS GLue...";

        while (!newlist.Any())
        {
            //Console.WriteLine("checking...");
            fileNames = await getGlueResults();
            newlist = fileNames.Where(item => item.Contains(fileYear)).ToList();
        }

        Console.WriteLine($"{fileYear} exists!");
        message3 = "All files have underwent ETL!";
        return true;
        
    }

    private async Task<List<string>> getGlueResults()
    {
        List<S3Object> li = await _fileHandler.ListObjectAsync("seconddatacalc");
        li.RemoveAt(0);

        List<string> filenames = li.Select(s => s.Key).ToList();
        return filenames;

    }
}